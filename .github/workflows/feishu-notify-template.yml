name: Feishu Notify Template (No Relay, Noise Control, Stable)

on:
  workflow_call:
    inputs:
      important_labels:
        default: "urgent,security,release-blocker"
        type: string
      important_paths_regex:
        default: "^(apps/web/|infra/|payment/|security/)"
        type: string
      pr_min_changed_files:
        default: "0"
        type: string
      title_keywords_regex:
        default: "(hotfix|rollback|security|incident)"
        type: string
      notify_issue_on_open_close_without_labels:
        default: "false"
        type: string
    secrets:
      FEISHU_WEBHOOK:
        required: true

jobs:
  pr_issue_notify:
    runs-on: ubuntu-latest
    env:
      IMP_LABELS: ${{ inputs.important_labels }}
      IMP_PATHS: ${{ inputs.important_paths_regex }}
      PR_MIN_FILES: ${{ inputs.pr_min_changed_files }}
      KW_REGEX: ${{ inputs.title_keywords_regex }}
      ISSUE_NOTIFY_LOOSE: ${{ inputs.notify_issue_on_open_close_without_labels }}
    steps:
      - name: Decide & Send (PR / Issue)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          echo "::group::Event payload"
          echo '${{ toJson(github.event) }}' | jq -C . | sed -e 's/^/  /'
          echo "::endgroup::"

          EVENT_NAME="${{ github.event_name }}"
          ACTION="${{ github.event.action }}"
          REPO="${{ github.repository }}"
          SENDER="${{ github.actor }}"
          API="${{ github.api_url }}"

          should_send=0
          header_color="blue"
          card_title="GitHub Notification"
          body_md=""
          url=""

          contains_label () {
            local wanted_csv="$1"
            local labels_csv="$2"
            IFS=',' read -r -a arr <<< "$wanted_csv"
            for l in "${arr[@]}"; do
              if echo "$labels_csv" | grep -Eiq "(^|,)\ *${l}\ *(,|$)"; then return 0; fi
            done
            return 1
          }

          to_csv_labels () {
            jq -r '(.pull_request.labels // .issue.labels // []) | map(.name) | join(",")' <<< '${{ toJson(github.event) }}'
          }

          if [[ "$EVENT_NAME" == "pull_request" ]]; then
            PR_NUM="${{ github.event.pull_request.number }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_BODY="$(jq -r '.pull_request.body // ""' <<< '${{ toJson(github.event) }}')"
            PR_URL="${{ github.event.pull_request.html_url }}"
            PR_FROM="${{ github.event.pull_request.head.ref }}"
            PR_TO="${{ github.event.pull_request.base.ref }}"
            PR_CHANGED="${{ github.event.pull_request.changed_files }}"
            PR_MERGED="${{ github.event.pull_request.merged }}"
            LABELS="$(to_csv_labels)"

            # 关键节点
            case "$ACTION" in
              opened|ready_for_review) should_send=1 ;;
              closed) [[ "$PR_MERGED" == "true" ]] && should_send=1 ;;
            esac

            # 其他触发条件（命中其一即可）
            contains_label "$IMP_LABELS" "$LABELS" && should_send=1
            echo "$PR_TITLE $PR_BODY" | grep -Eiq "$KW_REGEX" && should_send=1
            if [[ "$PR_MIN_FILES" =~ ^[0-9]+$ ]] && (( PR_CHANGED >= PR_MIN_FILES )); then
              should_send=1
            fi

            # 路径过滤（命中关键目录也触发）
            echo "Fetching changed files for path filter…"
            curl -s -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GH_TOKEN" \
              "$API/repos/$REPO/pulls/$PR_NUM/files?per_page=200" > files.json
            if jq -r '.[].filename' files.json | grep -Eq "$IMP_PATHS"; then
              should_send=1
            fi

            card_title="PR · $REPO #$PR_NUM · $ACTION"
            header_color="blue"
            [[ "$ACTION" == "closed" && "$PR_MERGED" == "true" ]] && header_color="green"
            url="$PR_URL"
            body_md="**Title:** $PR_TITLE\n**By:** $SENDER\n**From:** $PR_FROM → **To:** $PR_TO\n**Changed files:** $PR_CHANGED"

          elif [[ "$EVENT_NAME" == "issues" ]]; then
            ISSUE_NUM="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY="$(jq -r '.issue.body // ""' <<< '${{ toJson(github.event) }}')"
            ISSUE_URL="${{ github.event.issue.html_url }}"
            LABELS="$(to_csv_labels)"

            if [[ "$ACTION" == "reopened" ]]; then
              should_send=1
            elif [[ "$ACTION" == "opened" || "$ACTION" == "closed" ]]; then
              if contains_label "$IMP_LABELS" "$LABELS" || echo "$ISSUE_TITLE $ISSUE_BODY" | grep -Eiq "$KW_REGEX"; then
                should_send=1
              elif [[ "$ISSUE_NOTIFY_LOOSE" == "true" ]]; then
                should_send=1
              fi
            fi

            card_title="Issue · $REPO #$ISSUE_NUM · $ACTION"
            header_color="wathet"; [[ "$ACTION" == "closed" ]] && header_color="purple"
            url="$ISSUE_URL"
            SUMMARY="$(printf "%s" "$ISSUE_BODY" | tr '\n' ' ' | cut -c1-200)"
            body_md="**Title:** $ISSUE_TITLE\n**By:** $SENDER\n**Labels:** ${LABELS:-—}\n**Summary:** ${SUMMARY:-—}"

          else
            echo "Event $EVENT_NAME not handled."
            exit 0
          fi

          if [[ "$should_send" -ne 1 ]]; then
            echo "Noise filtered. Skip sending."
            exit 0
          fi

          cat > card.json <<'JSON'
          {
            "msg_type": "interactive",
            "card": {
              "header": { "template": "__COLOR__", "title": { "tag": "plain_text", "content": "__TITLE__" } },
              "elements": [
                { "tag": "div", "text": { "tag": "lark_md", "content": "_
