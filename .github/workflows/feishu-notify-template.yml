name: Feishu Notify Template (Python, Stable, No Relay)

on:
  workflow_call:
    inputs:
      important_labels:
        type: string
        default: "urgent,security,release-blocker"
      important_paths_regex:
        type: string
        default: "^(apps/web/|infra/|payment/|security/)"
      pr_min_changed_files:
        type: string
        default: "0"
      title_keywords_regex:
        type: string
        default: "(hotfix|rollback|security|incident)"
      notify_issue_on_open_close_without_labels:
        type: string
        default: "false"
    secrets:
      FEISHU_WEBHOOK:
        required: true

permissions:
  contents: read

jobs:
  pr_issue_notify:
    runs-on: ubuntu-latest

    steps:
      # â‘  è¿™é‡Œç”¨ GITHUB_ENV å®‰å…¨å†™å…¥â€œå¯èƒ½å«æ‹¬å·/æ­£åˆ™â€çš„å€¼ï¼Œé¿å… bash è§£æ
      - name: Prepare env safely
        shell: bash
        run: |
          {
            echo "IMP_LABELS=${{ inputs.important_labels }}"
            echo "PR_MIN_FILES=${{ inputs.pr_min_changed_files }}"
            echo "ISSUE_NOTIFY_LOOSE=${{ inputs.notify_issue_on_open_close_without_labels }}"
            echo "IMP_PATHS<<EOF"
            echo "${{ inputs.important_paths_regex }}"
            echo "EOF"
            echo "KW_REGEX<<EOF"
            echo "${{ inputs.title_keywords_regex }}"
            echo "EOF"
          } >> "$GITHUB_ENV"

      # â‘¡ ä¸»é€»è¾‘ï¼šPython è¯»å– envï¼Œé™å™ª+å‘é£ä¹¦å¡ç‰‡
      - name: Decide & Send (PR / Issue) â€” Python
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_API_URL: ${{ github.api_url }}
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          python3 - <<'PY'
          import json, os, re, sys, urllib.request, urllib.error

          def log_group(title, text):
              print(f"::group::{title}")
              print(text)
              print("::endgroup::")

          event_name = os.environ["GITHUB_EVENT_NAME"]
          with open(os.environ["GITHUB_EVENT_PATH"], "r", encoding="utf-8") as f:
              event = json.load(f)
          repo = os.environ["GITHUB_REPOSITORY"]
          api = os.environ["GITHUB_API_URL"]
          gh_token = os.environ["GH_TOKEN"]
          feishu = os.environ["FEISHU_WEBHOOK"]

          imp_labels = [x.strip() for x in os.getenv("IMP_LABELS","").split(",") if x.strip()]
          imp_paths = os.getenv("IMP_PATHS","")
          kw_regex  = os.getenv("KW_REGEX","")
          pr_min_files = int(os.getenv("PR_MIN_FILES","0") or "0")
          issue_loose = os.getenv("ISSUE_NOTIFY_LOOSE","false").lower() == "true"

          log_group("Event payload", json.dumps(event, indent=2))

          def labels_csv(labels):
              return ",".join([l.get("name","") for l in (labels or [])])

          def has_imp_label(labels):
              s = ",".join([l.get("name","") for l in (labels or [])]).lower()
              return any((","+x.lower()+",") in (","+s+",") for x in imp_labels)

          def match_kw(text):
              return bool(re.search(kw_regex, text or "", flags=re.I)) if kw_regex else False

          def gh_get(url):
              req = urllib.request.Request(url, headers={
                  "Accept":"application/vnd.github+json",
                  "Authorization": f"Bearer {gh_token}"
              })
              with urllib.request.urlopen(req) as r:
                  return json.loads(r.read().decode("utf-8"))

          def fetch_pr_files(pr_number):
              return gh_get(f"{api}/repos/{repo}/pulls/{pr_number}/files?per_page=200")

          def send_card(title, color, md, url):
              card = {
                "msg_type": "interactive",
                "card": {
                  "header": {"template": color, "title":{"tag":"plain_text","content": title}},
                  "elements":[
                    {"tag":"div","text":{"tag":"lark_md","content": md}},
                    {"tag":"action","actions":[
                      {"tag":"button","text":{"tag":"plain_text","content":"ğŸ”— Open in GitHub"},
                       "type":"primary","url": url}
                    ]}
                  ]
                }
              }
              body = json.dumps(card).encode("utf-8")
              req = urllib.request.Request(feishu, data=body, headers={"Content-Type":"application/json"})
              try:
                  with urllib.request.urlopen(req) as r:
                      resp = r.read().decode("utf-8")
                      log_group("Feishu response", f"HTTP {r.status}\n{resp}")
                      if r.status != 200: sys.exit(1)
              except urllib.error.HTTPError as e:
                  text = e.read().decode("utf-8", "ignore")
                  log_group("Feishu response (error)", f"HTTP {e.code}\n{text}")
                  sys.exit(1)

          should_send = False
          header_color = "blue"
          card_title = "GitHub Notification"
          body_md = ""
          url = ""

          if event_name == "pull_request":
              pr = event["pull_request"]
              action = event.get("action")
              pr_num = pr["number"]
              pr_title = pr.get("title","")
              pr_body = pr.get("body","") or ""
              pr_url = pr.get("html_url","")
              pr_from = pr.get("head",{}).get("ref","")
              pr_to = pr.get("base",{}).get("ref","")
              pr_changed = int(pr.get("changed_files") or 0)
              pr_merged = bool(pr.get("merged"))
              pr_labels = pr.get("labels",[])

              if action in ("opened","ready_for_review"): should_send = True
              if action == "closed" and pr_merged: should_send = True
              if has_imp_label(pr_labels): should_send = True
              if match_kw(pr_title + " " + pr_body): should_send = True
              if pr_min_files and pr_changed >= pr_min_files: should_send = True

              try:
                  files = fetch_pr_files(pr_num)
                  filenames = [f.get("filename","") for f in files]
                  if imp_paths and any(re.search(imp_paths, fn) for fn in filenames):
                      should_send = True
              except Exception as e:
                  log_group("Warn", f"Fetch files failed: {e}")

              card_title = f"PR Â· {repo} #{pr_num} Â· {action}"
              header_color = "green" if (action=="closed" and pr_merged) else "blue"
              actor = (event.get("sender") or event.get("actor") or {}).get("login", pr.get("user",{}).get("login",""))
              body_md = f"**Title:** {pr_title}\n**By:** {actor}\n**From:** {pr_from} â†’ **To:** {pr_to}\n**Changed files:** {pr_changed}"
              url = pr_url

          elif event_name == "issues":
              issue = event["issue"]
              action = event.get("action")
              issue_num = issue["number"]
              issue_title = issue.get("title","")
              issue_body = issue.get("body","") or ""
              issue_url = issue.get("html_url","")
              issue_labels = issue.get("labels",[])

              if action == "reopened":
                  should_send = True
              elif action in ("opened","closed"):
                  if has_imp_label(issue_labels) or match_kw(issue_title + " " + issue_body) or issue_loose:
                      should_send = True

              card_title = f"Issue Â· {repo} #{issue_num} Â· {action}"
              header_color = "purple" if action=="closed" else "wathet"
              summary = re.sub(r"\s+"," ",issue_body)[:200] if issue_body else "â€”"
              actor = (event.get("sender") or event.get("actor") or {}).get("login", issue.get("user",{}).get("login",""))
              body_md = f"**Title:** {issue_title}\\n**By:** {actor}\\n**Labels:** {labels_csv(issue_labels) or 'â€”'}\\n**Summary:** {summary}"
              url = issue_url

          else:
              print(f"Event {event_name} not handled.")
              sys.exit(0)

          if not should_send:
              print("Noise filtered. Skip sending.")
              sys.exit(0)

          log_group("Feishu request body", json.dumps({
              "title": card_title, "color": header_color, "md": body_md, "url": url
          }, indent=2))
          send_card(card_title, header_color, body_md, url)
          PY
