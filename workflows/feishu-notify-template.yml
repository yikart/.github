name: Feishu Notify Template (No Relay, Noise Control)

on:
  workflow_call:
    inputs:
      important_labels:
        description: "é€—å·åˆ†éš”ï¼šå‘½ä¸­è¿™äº›æ ‡ç­¾æ‰æ›´å€¾å‘é€šçŸ¥ï¼ˆissue å¿…é¡»å‘½ä¸­ï¼›PR å‘½ä¸­å³å¯æ”¾å®½å…¶ä»–æ¡ä»¶ï¼‰"
        required: false
        default: "urgent,security,release-blocker"
        type: string
      important_paths_regex:
        description: "å…³é”®ç›®å½•æ­£åˆ™ï¼ˆå‘½ä¸­å…¶ä¸€å³å¯é€šçŸ¥ï¼‰ï¼Œä¾‹å¦‚ ^(apps/web/|infra/|payment/|security/)"
        required: false
        default: "^(apps/web/|infra/|payment/|security/)"
        type: string
      pr_min_changed_files:
        description: "PR å˜æ›´æ–‡ä»¶æ•°é˜ˆå€¼ï¼ˆ>= åˆ™é€šçŸ¥ï¼‰ã€‚0 è¡¨ç¤ºä¸æŒ‰å¤§å°è¿‡æ»¤"
        required: false
        default: "0"
        type: string
      title_keywords_regex:
        description: "æ ‡é¢˜/æè¿°å…³é”®å­—æ­£åˆ™ï¼ˆå‘½ä¸­åˆ™é€šçŸ¥ï¼‰"
        required: false
        default: "(hotfix|rollback|security|incident)"
        type: string
      notify_issue_on_open_close_without_labels:
        description: "Issue åœ¨ opened/closed æ—¶æœªå‘½ä¸­å…³é”®æ ‡ç­¾ä¹Ÿé€šçŸ¥ï¼Ÿtrue/false"
        required: false
        default: "false"
        type: string
    secrets:
      FEISHU_WEBHOOK:
        required: true

jobs:
  pr_issue_notify:
    runs-on: ubuntu-latest
    env:
      IMP_LABELS: ${{ inputs.important_labels }}
      IMP_PATHS: ${{ inputs.important_paths_regex }}
      PR_MIN_FILES: ${{ inputs.pr_min_changed_files }}
      KW_REGEX: ${{ inputs.title_keywords_regex }}
      ISSUE_NOTIFY_LOOSE: ${{ inputs.notify_issue_on_open_close_without_labels }}
    steps:
      - name: Decide & Send (PR / Issue)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          EVENT_NAME="${{ github.event_name }}"
          ACTION="${{ github.event.action }}"
          REPO="${{ github.repository }}"
          SENDER="${{ github.actor }}"
          ORG="${{ github.repository_owner }}"
          API="${{ github.api_url }}"

          should_send=0
          header_color="blue"
          card_title="GitHub Notification"
          body_md=""
          url=""

          # ---------- helpers ----------
          contains_label () {
            labels_csv="$1"
            IFS=',' read -r -a arr <<< "$labels_csv"
            for l in "${arr[@]}"; do
              if echo "$2" | grep -Eiq "(^|,)\ *${l}\ *(,|$)"; then
                return 0
              fi
            done
            return 1
          }

          to_csv_labels () {
            jq -r '(.pull_request.labels // .issue.labels // []) | map(.name) | join(",")' <<< '${{ toJson(github.event) }}'
          }

          # ---------- pull_request ----------
          if [ "$EVENT_NAME" = "pull_request" ]; then
            # key fields
            PR_NUM="${{ github.event.pull_request.number }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_BODY="$(jq -r '.pull_request.body // ""' <<< '${{ toJson(github.event) }}')"
            PR_URL="${{ github.event.pull_request.html_url }}"
            PR_FROM="${{ github.event.pull_request.head.ref }}"
            PR_TO="${{ github.event.pull_request.base.ref }}"
            PR_CHANGED="${{ github.event.pull_request.changed_files }}"
            PR_MERGED="${{ github.event.pull_request.merged }}"
            LABELS="$(to_csv_labels)"

            # ---- baseline: å…³é”®èŠ‚ç‚¹æ‰è€ƒè™‘ ----
            if [ "$ACTION" = "opened" ] || [ "$ACTION" = "ready_for_review" ] || { [ "$ACTION" = "closed" ] && [ "$PR_MERGED" = "true" ]; }; then
              should_send=1
            fi

            # ---- å‘½ä¸­å…³é”®æ ‡ç­¾/å…³é”®å­—/å˜æ›´è§„æ¨¡/è·¯å¾„ å‡å¯è§¦å‘ ----
            if contains_label "$IMP_LABELS" "$LABELS"; then should_send=1; fi
            if echo "$PR_TITLE $PR_BODY" | grep -Eiq "$KW_REGEX"; then should_send=1; fi
            if [ "$PR_MIN_FILES" -gt 0 ] && [ "$PR_CHANGED" -ge "$PR_MIN_FILES" ]; then should_send=1; fi

            # è·¯å¾„è¿‡æ»¤ï¼šä»…å½“å˜æ›´å‘½ä¸­å…³é”®ç›®å½•æ‰æ”¾å®½ï¼ˆç”¨ API æ‹¿æ–‡ä»¶åˆ—è¡¨ï¼‰
            curl -s -H "Accept: application/vnd.github+json" \
                 -H "Authorization: Bearer $GH_TOKEN" \
                 "$API/repos/$REPO/pulls/$PR_NUM/files?per_page=200" > files.json
            if jq -r '.[].filename' files.json | grep -Eq "$IMP_PATHS"; then
              should_send=1
            fi

            # ---- é…è‰²ä¸æ ‡é¢˜ ----
            card_title="PR Â· $REPO #$PR_NUM Â· $ACTION"
            header_color="blue"
            if [ "$ACTION" = "closed" ] && [ "$PR_MERGED" = "true" ]; then header_color="green"; fi

            # ---- æ–‡æ¡ˆ ----
            url="$PR_URL"
            body_md="**Title:** $PR_TITLE\n**By:** $SENDER\n**From:** $PR_FROM â†’ **To:** $PR_TO\n**Changed files:** $PR_CHANGED"

          # ---------- issues ----------
          elif [ "$EVENT_NAME" = "issues" ]; then
            ISSUE_NUM="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY="$(jq -r '.issue.body // ""' <<< '${{ toJson(github.event) }}')"
            ISSUE_URL="${{ github.event.issue.html_url }}"
            LABELS="$(to_csv_labels)"

            # åŸºçº¿ï¼šåªåœ¨ opened/closed/reopened ä¸‹è€ƒè™‘
            if [ "$ACTION" = "reopened" ]; then
              should_send=1
            elif [ "$ACTION" = "opened" ] || [ "$ACTION" = "closed" ]; then
              # é»˜è®¤ï¼šå¿…é¡»å‘½ä¸­æ ‡ç­¾æˆ–å…³é”®è¯æ‰å‘ï¼›å¯é€šè¿‡è¾“å…¥å‚æ•°æ”¾å®½
              if contains_label "$IMP_LABELS" "$LABELS" || echo "$ISSUE_TITLE $ISSUE_BODY" | grep -Eiq "$KW_REGEX"; then
                should_send=1
              elif [ "$ISSUE_NOTIFY_LOOSE" = "true" ]; then
                should_send=1
              fi
            fi

            card_title="Issue Â· $REPO #$ISSUE_NUM Â· $ACTION"
            header_color="wathet"
            [ "$ACTION" = "closed" ] && header_color="purple"
            url="$ISSUE_URL"
            # å–å‰ 200 å­—åšæ‘˜è¦
            SUMMARY="$(printf "%s" "$ISSUE_BODY" | tr '\n' ' ' | cut -c1-200)"
            body_md="**Title:** $ISSUE_TITLE\n**By:** $SENDER\n**Labels:** ${LABELS:-â€”}\n**Summary:** ${SUMMARY:-â€”}"

          else
            echo "Event $EVENT_NAME not handled."
            exit 0
          fi

          if [ "$should_send" -ne 1 ]; then
            echo "Noise filtered. Skip sending."
            exit 0
          fi

          # ---------- å‘é€é£ä¹¦äº¤äº’å¡ç‰‡ ----------
          cat > card.json <<EOF
          {
            "msg_type": "interactive",
            "card": {
              "header": { "template": "${header_color}", "title": { "tag": "plain_text", "content": "${card_title}" } },
              "elements": [
                { "tag": "div", "text": { "tag": "lark_md", "content": "${body_md//\"/\\\"}" } },
                { "tag": "action", "actions": [
                  { "tag": "button", "text": { "tag": "plain_text", "content": "ğŸ”— Open in GitHub" }, "type": "primary", "url": "${url}" }
                ]}
              ]
            }
          }
          EOF

          curl -s -X POST '${{ secrets.FEISHU_WEBHOOK }}' \
               -H 'Content-Type: application/json' \
               -d @card.json | cat
